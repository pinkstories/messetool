<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<title>Messe Tool – Komplett</title>
<style>
    body { font-family: sans-serif; background: #f3f3f3; padding: 2rem; }
    .container { max-width: 800px; margin: auto; background: white; padding: 2rem; border-radius: 8px; }
    input, select, textarea { width: 100%; margin-bottom: 1rem; padding: 0.5rem; }
    ul { list-style: none; padding: 0; }
    button { padding: 0.5rem 1rem; margin: 0.25rem; cursor: pointer; }
    .red { background-color: #cc0000; color: white; border: none; }
    .green { background-color: #009900; color: white; border: none; }
    /* Neue Stile aus Inline-Styles */
    .container-right-margin {
        text-align: right;
        margin-top: 20px;
    }
    .flex-gap-center {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    .search-input {
        flex: 1;
        height: 2.5rem;
        padding: 0 1rem;
        font-size: 1rem;
        box-sizing: border-box;
    }
    .action-button {
        height: 2.5rem;
        padding: 0 1rem;
        font-size: 1rem;
        box-sizing: border-box;
        border: none; /* Einheitlicher Stil für Buttons */
    }
    .artikel-liste {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
    }
    .artikel-item {
        border: 1px solid #ccc;
        padding: 1rem;
        border-radius: 5px;
        width: calc(33% - 1rem); /* 3 Spalten Layout */
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .artikel-item h3 { margin-top: 0; font-size: 1.2rem; }
    .artikel-item p { margin-bottom: 0.5rem; font-size: 0.9rem; }
    .artikel-item button { width: 100%; margin-top: auto; } /* Button am unteren Rand */

    #warenkorb div {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0;
        border-bottom: 1px dashed #eee;
    }
    #warenkorb div:last-child {
        border-bottom: none;
    }
    #warenkorb button {
        width: 30px;
        height: 30px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        border-radius: 50%;
        border: 1px solid #ccc;
        background-color: #f0f0f0;
    }
    #warenkorb button.minus { background-color: #ffe0e0; }
    #warenkorb button.plus { background-color: #e0ffe0; }

    /* Stile für Formulare */
    #neukundeFormular, #artikelAnlegenFormular {
        margin-top: 20px;
        padding: 1rem;
        border: 1px solid #eee;
        border-radius: 8px;
        background-color: #f9f9f9;
    }
    .form-buttons {
        text-align: right;
    }
</style>
</head>
<body>
<div id="kundenwarnung"></div>
<div class="container container-right-margin">
    <h1>Messe-Bestelltool</h1>
    <div class="flex-gap-center">
        <input id="kundeSuche" placeholder="Bestandskunde suchen..." class="search-input" type="text"/>
        <button onclick="zeigeNeukundeFormular()" class="action-button green">+ Neukunde anlegen</button>
    </div>
    <ul id="suchErgebnisse"></ul>
</div>

<div class="container" id="neukundeFormular" style="display:none;">
    <h2>Neukunde anlegen</h2>
    <input id="neukundeName" placeholder="Name" type="text"/>
    <input id="neukundeOrt" placeholder="Ort" type="text"/>
    <div class="form-buttons">
        <button onclick="speichereNeukunde()" class="green">Speichern</button>
        <button onclick="versteckeNeukundeFormular()" class="red">Abbrechen</button>
    </div>
</div>

<div class="container">
    <h2>Aktueller Kunde: <span id="aktuellerKundeSpan">Nicht ausgewählt</span></h2>
    <input id="scanInput" placeholder="Artikel scannen/suchen..." class="search-input" type="text"/>
    <div class="flex-gap-center">
        <button onclick="filterArtikel()" class="action-button">Filter Anwenden</button>
        <button onclick="zeigeArtikelAnlegenFormular()" class="action-button green">+ Artikel anlegen</button>
    </div>
    <div id="artikelListe" class="artikel-liste"></div>
</div>

<div class="container" id="artikelAnlegenFormular" style="display:none;">
    <h2>Neuen Artikel anlegen</h2>
    <input id="artikelnummer" placeholder="Artikelnummer" type="text"/>
    <input id="artikelName" placeholder="Name" type="text"/>
    <input id="artikelPreis" placeholder="Preis" type="number" step="0.01"/>
    <input id="artikelVielfaches" placeholder="Vielfaches (z.B. 6)" type="number" step="1"/>
    <div class="form-buttons">
        <button onclick="speichereArtikel()" class="green">Speichern</button>
        <button onclick="versteckeArtikelAnlegenFormular()" class="red">Abbrechen</button>
    </div>
</div>

<div class="container">
    <h2>Warenkorb</h2>
    <div id="warenkorb"></div>
    <h3 id="gesamtpreis">Gesamt: 0,00 €</h3>
    <button onclick="exportiereBestellungen()" class="green">Bestellung exportieren (CSV)</button>
    <button onclick="warenkorbLeeren()" class="red">Warenkorb leeren</button>
</div>

<script>
    let kundenData = [
        {id: 1, name: "Muster GmbH", ort: "Berlin"},
        {id: 2, name: "Beispiel AG", ort: "München"}
    ];

    let artikelData = [
        {artikelnummer: "A001", name: "Laptop", preis: 1200.00, vielfaches: 1},
        {artikelnummer: "A002", name: "Maus", preis: 25.50, vielfaches: 5},
        {artikelnummer: "A003", name: "Tastatur", preis: 75.00, vielfaches: 1},
        {artikelnummer: "B001", name: "Monitor 24 Zoll", preis: 199.99, vielfaches: 1},
        {artikelnummer: "B002", name: "Webcam HD", preis: 49.90, vielfaches: 10}
    ];

    let aktuellerKunde = null;
    let warenkorb = [];

    // --- Hilfsfunktionen ---
    function formatCurrency(value) {
        return parseFloat(value).toFixed(2).replace(".", ",");
    }

    // --- Kundenverwaltung ---
    function setzeKunde(kunde) {
        aktuellerKunde = kunde;
        document.getElementById("aktuellerKundeSpan").textContent = `${kunde.name} (${kunde.ort})`;
        document.getElementById("suchErgebnisse").innerHTML = ""; // Suchergebnisse leeren
        document.getElementById("kundeSuche").value = ""; // Suchfeld leeren
        document.getElementById("kundenwarnung").textContent = ""; // Warnung entfernen
    }

    function zeigeNeukundeFormular() {
        document.getElementById("neukundeFormular").style.display = "block";
    }

    function versteckeNeukundeFormular() {
        document.getElementById("neukundeFormular").style.display = "none";
        document.getElementById("neukundeName").value = "";
        document.getElementById("neukundeOrt").value = "";
    }

    function speichereNeukunde() {
        const name = document.getElementById("neukundeName").value.trim();
        const ort = document.getElementById("neukundeOrt").value.trim();

        if (name && ort) {
            const neuerKunde = {
                id: kundenData.length ? Math.max(...kundenData.map(k => k.id)) + 1 : 1,
                name: name,
                ort: ort
            };
            kundenData.push(neuerKunde);
            setzeKunde(neuerKunde); // Neuen Kunden sofort auswählen
            versteckeNeukundeFormular();
        } else {
            alert("Name und Ort müssen ausgefüllt werden.");
        }
    }

    document.getElementById("kundeSuche").addEventListener("input", function() {
        const suchbegriff = this.value.toLowerCase();
        const ergebnisseListe = document.getElementById("suchErgebnisse");
        ergebnisseListe.innerHTML = ""; // Vorherige Ergebnisse leeren

        if (suchbegriff.length > 0) {
            const gefilterteKunden = kundenData.filter(kunde =>
                kunde.name.toLowerCase().includes(suchbegriff) || kunde.ort.toLowerCase().includes(suchbegriff)
            );

            let htmlContent = "";
            gefilterteKunden.forEach(kunde => {
                // Das Anführungszeichen innerhalb des JSON-Strings muss escaped werden
                htmlContent += `<li onclick="setzeKunde(${JSON.stringify(kunde).replace(/"/g, '&quot;')})">${kunde.name} (${kunde.ort})</li>`;
            });
            ergebnisseListe.innerHTML = htmlContent;
        }
    });

    // --- Artikelverwaltung ---
    function renderArtikelListe(filter = '') {
        const artikelListeDiv = document.getElementById("artikelListe");
        artikelListeDiv.innerHTML = "";
        const lowerCaseFilter = filter.toLowerCase();

        const gefilterteArtikel = artikelData.filter(artikel =>
            artikel.artikelnummer.toLowerCase().includes(lowerCaseFilter) ||
            artikel.name.toLowerCase().includes(lowerCaseFilter)
        );

        let htmlContent = "";
        gefilterteArtikel.forEach(artikel => {
            htmlContent += `
                <div class="artikel-item">
                    <h3>${artikel.name}</h3>
                    <p>Art.Nr.: ${artikel.artikelnummer}</p>
                    <p>Preis: ${formatCurrency(artikel.preis)} €</p>
                    <p>Vielfaches: ${artikel.vielfaches}</p>
                    <button onclick="artikelZumWarenkorb('${artikel.artikelnummer}')" class="green">Hinzufügen</button>
                </div>
            `;
        });
        artikelListeDiv.innerHTML = htmlContent;
    }

    function zeigeArtikelAnlegenFormular() {
        document.getElementById("artikelAnlegenFormular").style.display = "block";
    }

    function versteckeArtikelAnlegenFormular() {
        document.getElementById("artikelAnlegenFormular").style.display = "none";
        document.getElementById("artikelnummer").value = "";
        document.getElementById("artikelName").value = "";
        document.getElementById("artikelPreis").value = "";
        document.getElementById("artikelVielfaches").value = "";
    }

    function speichereArtikel() {
        const artikelnummer = document.getElementById("artikelnummer").value.trim();
        const name = document.getElementById("artikelName").value.trim();
        const preis = parseFloat(document.getElementById("artikelPreis").value);
        const vielfaches = parseInt(document.getElementById("artikelVielfaches").value);

        if (artikelnummer && name && !isNaN(preis) && preis > 0 && !isNaN(vielfaches) && vielfaches > 0) {
            const neuerArtikel = {artikelnummer, name, preis, vielfaches};
            artikelData.push(neuerArtikel);
            renderArtikelListe(); // Artikel-Liste aktualisieren
            versteckeArtikelAnlegenFormular();
        } else {
            alert("Bitte alle Felder korrekt ausfüllen.");
        }
    }

    function filterArtikel() {
        const filter = document.getElementById("scanInput").value;
        renderArtikelListe(filter);
    }

    // Initiales Laden der Artikel-Liste
    document.addEventListener("DOMContentLoaded", renderArtikelListe);


    // --- Warenkorb-Logik ---
    function artikelZumWarenkorb(artikelnummer) {
        if (!aktuellerKunde) {
            document.getElementById("kundenwarnung").textContent = "Bitte wählen Sie zuerst einen Kunden aus!";
            return;
        }
        document.getElementById("kundenwarnung").textContent = ""; // Warnung entfernen

        const artikel = artikelData.find(a => a.artikelnummer === artikelnummer);
        if (artikel) {
            const vorhandenesItem = warenkorb.find(item => item.artikelnummer === artikelnummer);
            if (vorhandenesItem) {
                vorhandenesItem.menge += artikel.vielfaches;
            } else {
                warenkorb.push({...artikel, menge: artikel.vielfaches});
            }
            renderWarenkorb();
        }
    }

    document.getElementById("scanInput").addEventListener("change", function() {
        const artikelnummer = this.value.trim();
        if (artikelnummer) {
            artikelZumWarenkorb(artikelnummer);
            this.value = ""; // Eingabefeld leeren nach dem Hinzufügen
        }
    });

    function renderWarenkorb() {
        const warenkorbDiv = document.getElementById("warenkorb");
        let htmlContent = "";
        let gesamtpreis = 0;

        warenkorb.forEach((item, i) => {
            const gesamtPreisArtikel = item.preis * item.menge;
            gesamtpreis += gesamtPreisArtikel;
            htmlContent += `
                <div>
                    <button data-index="${i}" data-diff="-${item.vielfaches}" class="minus">–</button>
                    ${item.artikelnummer} – ${item.name}, Menge: ${item.menge}, Preis: ${formatCurrency(item.preis)} €, Gesamt: ${formatCurrency(gesamtPreisArtikel)} €
                    <button data-index="${i}" data-diff="${item.vielfaches}" class="plus">+</button>
                </div>
            `;
        });
        warenkorbDiv.innerHTML = htmlContent;
        document.getElementById("gesamtpreis").textContent = `Gesamt: ${formatCurrency(gesamtpreis)} €`;
    }

    // Event-Delegation für Warenkorb-Buttons
    document.getElementById("warenkorb").addEventListener("click", function(event) {
        const target = event.target;
        if (target.tagName === 'BUTTON' && target.hasAttribute('data-index')) {
            const index = parseInt(target.dataset.index);
            const diff = parseInt(target.dataset.diff);
            aendereMenge(index, diff);
        }
    });

    function aendereMenge(i, diff) {
        warenkorb[i].menge += diff;
        if (warenkorb[i].menge <= 0) {
            warenkorb.splice(i, 1);
        }
        renderWarenkorb();
    }

    function warenkorbLeeren() {
        if (confirm("Möchten Sie den Warenkorb wirklich leeren?")) {
            warenkorb = [];
            renderWarenkorb();
        }
    }

    // --- Export-Funktion ---
    function exportiereBestellungen() {
        if (!aktuellerKunde) {
            alert("Bitte wählen Sie einen Kunden aus, bevor Sie exportieren.");
            return;
        }
        if (warenkorb.length === 0) {
            alert("Der Warenkorb ist leer.");
            return;
        }

        let csvContent = "Kundennummer;Kundenname;Artikelnummer;Menge;Einzelpreis;Gesamtpreis\n";
        warenkorb.forEach(item => {
            const gesamtPreisArtikel = item.menge * item.preis;
            csvContent += `${aktuellerKunde.id};"${aktuellerKunde.name} ${aktuellerKunde.ort}";${item.artikelnummer};${item.menge};${formatCurrency(item.preis)};${formatCurrency(gesamtPreisArtikel)}\n`;
        });

        const blob = new Blob([csvContent], {type: "text/csv;charset=utf-8;"});
        const link = document.createElement("a");
        if (link.download !== undefined) { // Feature detection
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Bestellung_${aktuellerKunde.name.replace(/ /g, '_')}_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else {
            alert("Ihr Browser unterstützt das automatische Herunterladen von Dateien nicht. Bitte kopieren Sie den Inhalt manuell.");
            console.log(csvContent);
        }
    }
</script>
</body>
</html>
